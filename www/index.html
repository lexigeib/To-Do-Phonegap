<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src *" />
    <link rel="stylesheet" type="text/css" href="css/index.css" />
      <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript">
document.addEventListener('deviceready', onDeviceReady, false);   
function onDeviceReady(){
  var size =0;
  var type = LocalFileSystem.PERSISTENT;  
  window.requestFileSystem(type, size, fileSuccess, errorCall);
    alert('Recieving table file....');
    function fileSuccess(fs){
            alert('file system open: ' + fs.name);
        fs.root.getFile('table.txt', {create: true, exclusive: false}, function(fileEntry){
            if (fileEntry.isFile){
                alert('file found at: ' + fs.fullPath);
            } else {
                alert('File not found, recreating empty file.')
                writeFile(fileEntry, null);
            };
            }, errorCall);
    }
    tablePaste();
    checkDate();
}
function errorCall(error){
    alert("Error Code: "+ error.code + error);
}        
function appendTable() {
    var txt = document.getElementById('task').value;
    var date = document.getElementById('date').value;
    var priority = document.getElementById('priority').value;
    var category = document.getElementById('category').value;
    var table = document.getElementById('table-container');
    
    table.insertAdjacentHTML('beforeend',`<tr><td class="tg-rykj"><input type="radio" class="done"></td><td class="tg-cly1">${txt}</td><td class="dates">${date}</td><td class="tg-cly1">${priority}</td><td class="tg-cly1">${category}</td></tr>`);
    
    var size = 0;
    
    window.requestFileSystem(LocalFileSystem.PERSISTENT, size, successCall, errorCall);
    function successCall(fs){
        fs.root.getFile('table.txt',{create:true, exclusive: false}, function(fileEntry){
        fileEntry.createWriter(function(fileWriter){
            fileWriter.onwriteend = function(e){
                alert("onwriteend complete.");
            };
            fileWriter.onerror = function(e){
                alert("write failed: "+ e.toString());
            };
            var output = document.getElementById('table-container').innerHTML;
            fileWriter.write(output);
            
        }, errorCall);    
        }, errorCall);
        document.getElementById('task').value="";
    document.getElementById('date').value="";    
    };
}
function tablePaste() {
    
    var size = 0;    
    window.requestFileSystem(LocalFileSystem.PERSISTENT, size, successCall, errorCall);
    
    function successCall(fs){
        alert('Accessing File');
        fs.root.getFile('table.txt',{create: true, exclusive: false},function(fileEntry){
        fileEntry.file(function(file){
            var reader = new FileReader();
            reader.onloadend = function(e){  
            var table = document.getElementById('table-container');
            table.insertAdjacentHTML('beforeend', this.result);
            alert('File added');    
            };
        reader.readAsText(file);
        }, errorCall);    
        }, errorCall);
    };
}        
function checkDate() {
    console.log('activated datecheck');
  var entries = document.getElementsByClassName('dates');
    var today = new Date();
for (var i = 0; i < entries.length; i++){
    console.log(entries[i].textContent);
    var startDate = new Date(entries[i].textContent + 'EST');
  if (startDate.getDate() < today.getDate()) {
    var entry = entries[i];  
    entry.style.color = "red";
  }
   else if (startDate.getDate() === today.getDate()) {
    var entry = entries[i];  
    entry.style.fontWeight = "bold";
  } 
    else {
      
  };
    };
}
function eraseRow() {
    console.log('checking rows');
    var table = document.getElementById('table-container');
    var buttons = document.getElementsByClassName('done');
    for (var i = 0; i < buttons.length; i++){
        if (buttons[i].checked){
          table.deleteRow(i);
        }
    }
}        
var date = setInterval(checkDate, 9000);
var removal = setInterval(eraseRow, 9000);
    </script>
    
    <title>TODO</title>
</head>
<body style="color: grey">
    <script type="text/javascript"> 
    app.initialize();
    </script>
  <br>
    <h1 style="text-align: center">To-Do List</h1>
    <br>
<table class="tg" style="width:100%">
  <tr>
    <th class="tg-vlyc">Complete?<br></th>
    <th class="tg-0pky">Task</th>
    <th class="tg-0pky"><img height="50px" width="50px" src="img/calendar.png"<br></th>
    <th class="tg-0lax">Priority</th>
    <th class="tg-0lax">Category</th>
  </tr>
</table>
    <div id=container><table id="table-container" class="tg"></table></div>
    <div id="content">
    <input type="text" id="task"/>
        <input type="date" id="date"/>
        <select id='priority'>
   <option value='Low' selected>Low</option>
   <option value='Med'>Med</option> 
   <option value='High'>High</option>
<select>
    <select id='category'>
   <option value='Work' selected>Work</option>
   <option value='Personal'>Personal</option>
<select>
    <button onclick="appendTable()" id="buttonimg"><img style="height: 30px;width: 30px; margin-bottom: -10px"src="img/angle-right@1x.png"></button>
    </div>
</body>

</html>